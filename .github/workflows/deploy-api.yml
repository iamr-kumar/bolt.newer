name: Deploy to Azure VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up SSH with password authentication
        run: |
          sudo apt-get install -y sshpass

      - name: Deploy to Azure VM
        run: |
          sshpass -p "${{ secrets.AZURE_SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.AZURE_SSH_USER }}@${{ secrets.AZURE_VM_IP }} << 'EOF'

            sudo su
            cd ~/projects/bolt.newer
            git checkout main || exit 1
            git pull --no-rebase || exit 1
            ls -la ~/projects/bolt.newer
            cd ~/projects/bolt.newer/be

            docker build -t bn-api . || exit 1
            docker stop bn-api || true
            docker rm bn-api || true

            docker run -d -p 5001:5001 --name bn-api --env-file ~/projects/bolt.newer/be/.env bn-api || exit 1

            echo "Deployment complete!"
          EOF
